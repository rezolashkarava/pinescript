// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Pagani
// @version=6

indicator("Regime-Aware Institutional VWAP", 
     shorttitle = "RA-VWAP", 
     overlay = false,
     format = format.price,
     precision = 2,
     max_lines_count = 50)

// ══════════════════════════════════════════════════════════════════════════════
//                         REGIME-AWARE INSTITUTIONAL VWAP
// ══════════════════════════════════════════════════════════════════════════════
//
// PURPOSE: Z-Score oscillator showing statistical distance from VWAP with 
//          CVD-based regime detection for identifying trend vs divergence.
//
// METHODOLOGY:
// • VWAP: Volume-Weighted Average Price (cumulative from anchor)
// • CVD Proxy: Chaikin Money Flow Multiplier × Volume
// • Z-Score: (Price - VWAP) / σ, clamped to ±5
//
// REGIME STATES:
// • BULL: Price > VWAP, CVD rising (trend confirmation)
// • BEAR: Price < VWAP, CVD falling (trend confirmation)
// • DISTRIB: Price > VWAP, CVD falling (bearish divergence - short signal)
// • ACCUM: Price < VWAP, CVD rising (bullish divergence - long signal)
//
// ══════════════════════════════════════════════════════════════════════════════

// ─────────────────────────────────────────────────────────────────────────────
// INPUTS
// ─────────────────────────────────────────────────────────────────────────────

string GRP_CORE = "Core Settings"
string GRP_MODE = "Mode"
string GRP_VISUAL = "Visual"

// Core
i_anchor = input.string("Session", "Anchor Method", 
     options = ["Session", "Pivot High", "Pivot Low", "Volume Spike", "None"], 
     group = GRP_CORE,
     tooltip = "Session: Reset daily (recommended for crypto)\nPivot: Reset on swing high/low\nVolume Spike: Reset on 3x avg volume")

i_pivotLenBase = input.int(10, "Pivot Lookback", 
     minval = 3, maxval = 50, group = GRP_CORE,
     tooltip = "Bars left/right to confirm swing pivot")

i_cvdLenBase = input.int(10, "CVD Momentum Period", 
     minval = 3, maxval = 30, group = GRP_CORE,
     tooltip = "Period for measuring CVD rate of change")

i_cvdSmoothLen = input.int(3, "CVD Smoothing", 
     minval = 1, maxval = 10, group = GRP_CORE,
     tooltip = "EMA smoothing applied to CVD before momentum calc")

// Mode
i_autoMode = input.bool(false, "Auto-Adapt to Timeframe", 
     group = GRP_MODE,
     tooltip = "Scales lookback periods based on timeframe. Baseline = 5min")

i_showTable = input.bool(true, "Show Info Panel", group = GRP_MODE)

// Visual
i_displayMode = input.string("Line", "Display Mode", 
     options = ["Line", "Histogram"], group = GRP_VISUAL,
     tooltip = "Line: Smooth oscillator\nHistogram: Column bars")

i_bull = input.color(#26A69A, "Bull", group = GRP_VISUAL, inline = "c1")
i_bear = input.color(#EF5350, "Bear", group = GRP_VISUAL, inline = "c1")
i_warn = input.color(#FF9800, "Divergence", group = GRP_VISUAL, inline = "c2")
i_neut = input.color(#78909C, "Neutral", group = GRP_VISUAL, inline = "c2")

// ─────────────────────────────────────────────────────────────────────────────
// TIMEFRAME SCALING
// ─────────────────────────────────────────────────────────────────────────────

f_tfMinutes() =>
    switch timeframe.period
        "1" => 1
        "3" => 3
        "5" => 5
        "15" => 15
        "30" => 30
        "45" => 45
        "60" => 60
        "120" => 120
        "180" => 180
        "240" => 240
        "D" => 1440
        "W" => 10080
        => na(str.tonumber(timeframe.period)) ? 60 : str.tonumber(timeframe.period)

float tfMinutes = f_tfMinutes()
float tfScale = i_autoMode ? math.max(0.5, math.min(3.0, math.sqrt(tfMinutes / 5.0))) : 1.0

int pivotLen = int(math.round(i_pivotLenBase * tfScale))
int cvdLen = int(math.round(i_cvdLenBase * tfScale))

// ─────────────────────────────────────────────────────────────────────────────
// ANCHOR DETECTION
// ─────────────────────────────────────────────────────────────────────────────

bool newSession = ta.change(time("D")) != 0
float pivotHigh = ta.pivothigh(high, pivotLen, pivotLen)
float pivotLow = ta.pivotlow(low, pivotLen, pivotLen)
float volMA = ta.sma(volume, 20)
bool volSpike = volume > volMA * 3 and volume > 0

bool doReset = switch i_anchor
    "Session" => newSession
    "Pivot High" => not na(pivotHigh)
    "Pivot Low" => not na(pivotLow)
    "Volume Spike" => volSpike
    => false

if bar_index == 0
    doReset := true

// ─────────────────────────────────────────────────────────────────────────────
// VWAP CALCULATION
// ─────────────────────────────────────────────────────────────────────────────

var float sumPV = 0.0
var float sumV = 0.0
var float sumPV2 = 0.0

float src = hlc3

if doReset
    sumPV := src * volume
    sumV := volume
    sumPV2 := src * src * volume
else
    sumPV += src * volume
    sumV += volume
    sumPV2 += src * src * volume

float vwapVal = sumV > 0 ? sumPV / sumV : src
float variance = sumV > 0 ? math.max(sumPV2 / sumV - vwapVal * vwapVal, 0) : 0
float stdev = math.sqrt(variance)

// ─────────────────────────────────────────────────────────────────────────────
// CVD CALCULATION (Chaikin Money Flow Method)
// ─────────────────────────────────────────────────────────────────────────────

float rangeHL = high - low
float mfMultiplier = rangeHL > 0 ? ((close - low) - (high - close)) / rangeHL : 0.0
float delta = mfMultiplier * volume

var float cvd = 0.0
if doReset
    cvd := delta
else
    cvd += delta

float cvdEMA = ta.ema(cvd, i_cvdSmoothLen)
max_bars_back(cvdEMA, 100)
float cvdMomentum = cvdEMA - cvdEMA[cvdLen]

// ─────────────────────────────────────────────────────────────────────────────
// REGIME DETECTION
// ─────────────────────────────────────────────────────────────────────────────

bool priceAbove = close > vwapVal
bool priceBelow = close < vwapVal
bool cvdUp = cvdMomentum > 0
bool cvdDown = cvdMomentum < 0

bool bullTrend = priceAbove and cvdUp
bool bearTrend = priceBelow and cvdDown
bool absorption = priceAbove and cvdDown
bool accumulation = priceBelow and cvdUp

color regimeColor = bullTrend ? i_bull : bearTrend ? i_bear : absorption or accumulation ? i_warn : i_neut

// ─────────────────────────────────────────────────────────────────────────────
// Z-SCORE
// ─────────────────────────────────────────────────────────────────────────────

float rawZScore = stdev > 0 ? (close - vwapVal) / stdev : 0.0
float zScore = math.max(-5.0, math.min(5.0, rawZScore))
color zColor = zScore >= 2 ? i_bear : zScore <= -2 ? i_bull : i_neut

// ─────────────────────────────────────────────────────────────────────────────
// PLOTS
// ─────────────────────────────────────────────────────────────────────────────

color zPlotColor = zScore >= 2 ? i_bear : zScore <= -2 ? i_bull : zScore > 0 ? color.new(i_bear, 50) : color.new(i_bull, 50)

// Histogram mode
plot(i_displayMode == "Histogram" ? zScore : na, "Z-Score Histogram", zPlotColor, style = plot.style_columns, histbase = 0)

// Line mode
plot(i_displayMode == "Line" ? zScore : na, "Z-Score Line", zPlotColor, linewidth = 2)

// Zero line
hline(0, "Zero", color.new(#787B86, 70), linestyle = hline.style_solid)

// Glowing bands using fills
p_top3 = plot(5, "Top", color.new(color.white, 100), display = display.none)
p_top2 = plot(3, "+3σ", color.new(i_bear, 85), linewidth = 1)
p_top1 = plot(2, "+2σ", color.new(i_bear, 75), linewidth = 1)
p_zero = plot(0, "Mid", color.new(color.white, 100), display = display.none)
p_bot1 = plot(-2, "-2σ", color.new(i_bull, 75), linewidth = 1)
p_bot2 = plot(-3, "-3σ", color.new(i_bull, 85), linewidth = 1)
p_bot3 = plot(-5, "Bot", color.new(color.white, 100), display = display.none)

// Gradient fills for glow effect
fill(p_top2, p_top3, color.new(i_bear, 92), title = "Extreme OB Zone")
fill(p_top1, p_top2, color.new(i_bear, 95), title = "OB Zone")
fill(p_zero, p_top1, color.new(i_neut, 98), title = "Upper Neutral")
fill(p_zero, p_bot1, color.new(i_neut, 98), title = "Lower Neutral")
fill(p_bot1, p_bot2, color.new(i_bull, 95), title = "OS Zone")
fill(p_bot2, p_bot3, color.new(i_bull, 92), title = "Extreme OS Zone")

// ─────────────────────────────────────────────────────────────────────────────
// INFO PANEL
// ─────────────────────────────────────────────────────────────────────────────

var table panel = table.new(position.top_right, 2, 5, color.new(#131722, 0), color.new(#363A45, 0), 1)

if i_showTable and barstate.islast
    string regimeTxt = bullTrend ? "BULL ↑" : bearTrend ? "BEAR ↓" : absorption ? "DISTRIB ⚠" : accumulation ? "ACCUM ⚠" : "NEUTRAL"
    string cvdTxt = cvdUp ? "BUYING ↑" : cvdDown ? "SELLING ↓" : "NEUTRAL"
    string modeTxt = i_autoMode ? "AUTO ×" + str.tostring(tfScale, "#.#") : "FIXED"
    
    table.cell(panel, 0, 0, "VWAP", text_color = color.gray, text_size = size.small)
    table.cell(panel, 1, 0, str.tostring(vwapVal, format.mintick), text_color = color.white, text_size = size.small)
    table.cell(panel, 0, 1, "Regime", text_color = color.gray, text_size = size.small)
    table.cell(panel, 1, 1, regimeTxt, text_color = regimeColor, text_size = size.small)
    table.cell(panel, 0, 2, "Z-Score", text_color = color.gray, text_size = size.small)
    table.cell(panel, 1, 2, str.tostring(zScore, "#.##") + "σ", text_color = zColor, text_size = size.small)
    table.cell(panel, 0, 3, "CVD", text_color = color.gray, text_size = size.small)
    table.cell(panel, 1, 3, cvdTxt, text_color = cvdUp ? i_bull : cvdDown ? i_bear : i_neut, text_size = size.small)
    table.cell(panel, 0, 4, "Mode", text_color = color.gray, text_size = size.small)
    table.cell(panel, 1, 4, modeTxt, text_color = i_autoMode ? color.new(#2196F3, 0) : color.white, text_size = size.small)

// ─────────────────────────────────────────────────────────────────────────────
// ALERTS (confirmed bar only)
// ─────────────────────────────────────────────────────────────────────────────

bool confirmedAbsorption = absorption and not absorption[1] and barstate.isconfirmed
bool confirmedAccumulation = accumulation and not accumulation[1] and barstate.isconfirmed

alertcondition(confirmedAbsorption, "Distribution", "Price > VWAP but CVD falling")
alertcondition(confirmedAccumulation, "Accumulation", "Price < VWAP but CVD rising")
alertcondition(zScore >= 3 and barstate.isconfirmed, "Extreme OB", "Z-Score ≥ 3σ")
alertcondition(zScore <= -3 and barstate.isconfirmed, "Extreme OS", "Z-Score ≤ -3σ")
alertcondition(ta.crossover(close, vwapVal) and barstate.isconfirmed, "Cross Up", "Price crossed above VWAP")
alertcondition(ta.crossunder(close, vwapVal) and barstate.isconfirmed, "Cross Down", "Price crossed below VWAP")

// ══════════════════════════════════════════════════════════════════════════════
// END
// ══════════════════════════════════════════════════════════════════════════════
